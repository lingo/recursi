var thumb  = require('node-thumbnail');
var events = require('events');
var fs     = require('fs');
var path   = require('path');
var jade   = require('jade');
var util   = require('util');
var mime   = require('mime');
var crypto = require('crypto');
var fsread = require('folder_reader');

// Template engine
var gen_dir_view = jade.compile([
  '.directory',
  '  h2 #{dir.path}',
  '  ul.folder'
].join('\n'));

var gen_files_view = jade.compile([
    '- each file in files',
    '  .file(data-path="#{file.path}", data-type="#{file.type}", data-name="#{file.name}", id="#{file.id}")',
    '    .icon',
    '      img(src="icons/#{file.type}.png")',
    '    .name #{file.name}',
].join('\n'));

// Our type
function Folder(app, jquery_element, options) {
  events.EventEmitter.call(this);
  this.element = jquery_element;
  this.app     = app;
  this.options = options;

  var self = this;
  // Click on blank
  this.element.on('click', function() {
    self.element.find('.focus').removeClass('focus');
  });
  // Click on file
  this.element.delegate('.file', 'click', function(e) {
    self.element.find('.focus').removeClass('focus');
    $(this).addClass('focus');
    e.stopPropagation();
  });
  // Double click on file
  this.element.delegate('.file', 'dblclick', function() {
    var file_path = $(this).attr('data-path');
    self.emit('navigate', file_path, mime.stat(file_path));
  });

  var scrollDebounceTime = 100;
  this.timerID = null;

  this.element.on('scroll', function(e) {
    if (self.timerID) {
      clearTimeout(self.timerID);
      self.timerID = null;
    }
    self.timerID = setTimeout(function() { self.onScroll(e); }, scrollDebounceTime);
  });
}

util.inherits(Folder, events.EventEmitter);

Folder.prototype.hashPath = function(path) {
    var hash = crypto.createHash('sha1');
    hash.update(path);
    return hash.digest('hex');
};

Folder.prototype.updateVisibleThumbnails = function() {
  var self   = this;
  var items  = this.getVisibleItems();
  items.addClass('loading'); 
  var tItems = items.map(function() {
    var elt = $(this);
    var path = {
      name: elt.data().name,
      path: elt.data().path,
      id:   elt.attr('id'),
      type: elt.data().type
    };
    return path;
  });
  this.updateThumbnails(tItems, function(elt, path, opts, settings) { elt.removeClass('loading'); });
};

Folder.prototype.getVisibleItems = function() {
  // Find current first icon
  var self         = this;
  var threshold    = 500; // in px
  var visibleItems = $();
  var $win         = $(window);
  var topCutoff    = $win.scrollTop(); //todo: use icon size here
  var bottomCutoff = $win.height() - $win.scrollTop(); //todo: use icon size here
  
  topCutoff    -= threshold;
  bottomCutoff += threshold;

  var items = self.element.find('.file');

  items.each(function() {
    var $this = $(this);
    if ($this.offset().top >= topCutoff && ($this.offset().top + $this.outerHeight()) <= bottomCutoff) {
      visibleItems.push(this);
    }
  });
  return visibleItems;
};


Folder.prototype.onScroll = function(event) {

  // Clear thumbnailing queue
  thumb.cancel();
  this.updateVisibleThumbnails();
};

Folder.prototype.open = function(dir) {
  var self = this;
  if (typeof dir === 'undefined') {
    dir = self.currentDir;
  } else {
    self.currentDir = dir;
  }
  if (!dir) {
    window.alert('no current dir');
    return false;
  }
  self.element.empty();
  var options = { showHidden: self.app.showHidden };
  console.log('Folder.open, app are', self.app);

  fsread.readDir(dir, function(dir, files) {
    // console.log('callback entered', dir, files);
    var out = [];
    for (var i = 0; i < files.length; ++i) {
      files[i].id = self.hashPath(files[i].path);
      if (files[i].type === 'image' || files[i].type === 'folder') {
        out.push(files[i]);
      }
    }
    self.render(dir, out);
  }, options);
}

Folder.prototype.render = function(dirPath, files) {
  if (files.length) {
    var filesHTML = gen_files_view({ files: files });
    var dirElt = this.element.append(gen_dir_view({ dir: {path: dirPath}})).find('.folder:last');
    dirElt.html(filesHTML);
    this.updateVisibleThumbnails();
    // this.updateThumbnails(files);
  }
    // this.element.find('.directory > h2').text(dirPath);
};

Folder.prototype.updateThumbnails = function(images, perItemCB, onCompleteCB) {
  var self = this;
  var width = self.app.thumbSize;
  console.group("Thumbnailing ", images);
  if (typeof(images) === 'undefined') {
    images = self.images;
  }
  if (typeof(images) === 'undefined') {
    console.warn('No images provided');
    console.groupEnd();
    return;
  }

  var dest = path.join("" + self.app.app.dataPath, "/thumbs/");
  console.log('Thumbnail dest path', dest);
  thumb.thumb({
    width:       width,
    images:      images,
    destination: dest,
    concurrency: 4,
    digest:      true,
    
    perItemCallback: function(image, options, settings) {
      // console.group(image);
      // console.log('options', options);
      // console.log('settings', settings);
      console.log('perItemCallback',image, options, settings);

      var hash = crypto.createHash('sha1');
      hash.update(options.srcPath);
      var id = hash.digest('hex');

      // console.log("hashed path to html ID: ", options.srcPath, '=>', id);

      var elt = $('#' + id);
      if (elt.length) {
        // console.log('updating HTML elt', elt);
        elt.attr('data-thumbpath', options.dstPath);
        elt.find('.icon img').attr('src', options.dstPath);
      } else {
        console.error('failed to find element for image',image,id);
      }
      if (typeof(perItemCB) === 'function') {
        perItemCB(elt, image, options, settings);
      }
      console.groupEnd();
    }
  }, function() {
    if (typeof(onCompleteCB) === 'function') {
      onCompleteCB();
    }
    console.groupEnd();
  });
};

Folder.prototype.cancelThumbs = function() {
  thumb.cancel();
};
exports.Folder = Folder; 
